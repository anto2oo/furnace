#!/bin/bash

_help() {

	_USAGE="OPTIONS"
	_DESCRIPTION="Configure a virtual host with httpd."
	_HELP["username"]="Specify the username"
	_HELP["domain"]="Specify the new domain name"
}

_params() {
	_PARAM["username"]="u"
	_PARAM["domain"]="d"
	_PARAM_FLAG["allow-web-services"]=""

}

_method() {
if [ "$(grep -c "^${_ARG[username]}:" /etc/passwd)" = 0 ]; then
	raise fatal "User ${_ARG[username]} not in /etc/passwd"
fi

if ! mkdir /home/"${_ARG[username]}"/"${_ARG[domain]}"/{web,logs}; then
	raise warning "Failed to create ${_ARG[domain]} website home"
fi

base_domain=$(echo ${_ARG[domain]} |  awk -F "." '{printf $(NF-1)"."$NF }')
if [ -f "${INSTALL_DIR}"/dns/${base_domain}.txt ]; then
	base_dns_zone=$(cat "${INSTALL_DIR}"/dns/${base_domain}.txt | sed '1d')
fi
echo ";; Auto-generated by furnace.sh on $(date +"%Y-%m-%d %H:%M:%S")
$base_dns_zone
;; A Record for ${_ARG[domain]}
${_ARG[domain]}.   1   IN  A   ${server_addr}
" > "${INSTALL_DIR}"/dns/${base_domain}.txt


chown "${_ARG[username]}:${_ARG[username]}" /home/"${_ARG[username]}"/"${_ARG[domain]}"

chmod 751 /home/"${_ARG[username]}"/"${_ARG[domain]}"

cp -n "${INSTALL_DIR}"/templates/skeleton/user.html /home/"${_ARG[username]}"/"${_ARG[domain]}"/web/index.php

username="${_ARG[username]}" domain="${_ARG[domain]}" envsubst '$username,$domain' < "${INSTALL_DIR}"/templates/httpd/host.conf > /etc/httpd/conf.d/"${_ARG[username]}"_"${_ARG[domain]}".conf

if [[ "${_FLAG["allow-web-services"]}" = 1 ]]; then
	sed -i '/<\/Virtualhost>/i \
	Include conf/services.conf \
	'  /etc/httpd/conf.d/"${_ARG[username]}"_"${_ARG[domain]}".conf
fi

systemctl reload httpd

raise notice "Successfully created ${_ARG[domain]} for user ${_ARG[username]}"

}