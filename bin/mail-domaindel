#!/bin/bash

_help() {

	_USAGE="OPTIONS"
	_DESCRIPTION="Remove configurations for a mail domain configured with furnace"
	_HELP["domain"]="Specify the mail domain to remove"
}

_params() {
	_PARAM["domain"]="d"

}

_method() {

if [[ ! "$(grep -m 1 "${_ARG[domain]} " /etc/postfix/furnace/mail_domains)" ]]; then
   raise fatal "Could not remove domain ${_ARG[domain]}; not found in /etc/postfix/furnace/mail_domains"
fi

if [[ ! "$(grep -m 1 "default._domainkey.${_ARG[domain]} " /etc/opendkim/KeyTable)" ]]; then
	raise fatal "Could not remove domain ${_ARG[domain]}; not found in /etc/opendkim/KeyTable"
fi

if [[ ! "$(grep -m 1 "*@${_ARG[domain]} " /etc/opendkim/SigningTable)" ]]; then
	raise fatal "Could not remove domain ${_ARG[domain]}; not found in /etc/opendkim/SigningTable"
fi

if [[ ! "$(grep -m 1 "${_ARG[domain]} " /etc/opendkim/TrustedHosts)" ]]; then
   raise fatal "Could not remove domain ${_ARG[domain]}; not found in /etc/opendkim/TrustedHosts"
fi

if cat /etc/postfix/furnace/mail_aliases | grep "@${_ARG[domain]} " > /dev/null; then
	raise fatal "Could not remove domain ${_ARG[domain]}; there are still mail addresses using this domain"
fi

sed -i "/${_ARG[domain]} /d" /etc/postfix/furnace/mail_domains
postmap /etc/postfix/furnace/mail_domains

rm -Rf /etc/opendkim/keys/"${_ARG[domain]}"

sed -i "/default._domainkey.${_ARG[domain]} /d" /etc/opendkim/KeyTable
sed -i "/\*@${_ARG[domain]} /d" /etc/opendkim/SigningTable
sed -i "/${_ARG[domain]} /d" /etc/opendkim/TrustedHosts

base_domain=$(echo ${_ARG[domain]} |  awk -F "." '{printf $(NF-1)"."$NF }')
base_dns_zone=$(cat "${INSTALL_DIR}"/dns/${base_domain}.txt | sed '1d' | sed -e "/;;; Begin mail configuration for ${_ARG[domain]}/,+10d")

echo ";; Auto-generated by furnace on $(date +"%Y-%m-%d %H:%M:%S")
$base_dns_zone
" > "${INSTALL_DIR}"/dns/${base_domain}.txt

raise notice "Removed mail services for domain ${_ARG[domain]}"

systemctl reload opendkim postfix

}