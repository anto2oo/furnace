#!/bin/bash

_help() {

	_USAGE="OPTIONS"
	_DESCRIPTION="Remove a virtual host. This will not delete its web root, unless --delete-root is specified (see below)"
	_HELP["username"]="Specify the username of the website owner"
	_HELP["domain"]="Specify the domain to delete"
	_HELP["delete-root"]="Delete the content of the website"
}

_params() {
	_PARAM["username"]="u"
	_PARAM["domain"]="d"
	_PARAM_FLAG["delete-root"]=""

}

_method() {

if [ "$(grep -c "^${_ARG[username]}:" /etc/passwd)" = 0 ]; then
	raise fatal "User ${_ARG[username]} not in /etc/passwd"
fi

if [ -f "/etc/httpd/conf.d/${_ARG[username]}_${_ARG[domain]}" ]; then
	rm /etc/httpd/conf.d/"${_ARG[username]}_${_ARG[domain]}".conf
	base_domain=$(echo ${_ARG[domain]} |  awk -F "." '{printf $(NF-1)"."$NF }')
	base_dns_zone=$(cat /usr/share/furnace/dns/${base_domain}.txt | sed '1d' | sed -e "/;; A Record for ${_ARG[domain]}/,+2d")
	echo ";; Auto-generated by furnace.sh on $(date +"%Y-%m-%d %H:%M:%S")
$base_dns_zone
" > /usr/share/furnace/dns/${base_domain}.txt 
	systemctl reload httpd
else
	raise fatal "Website ${_ARG[domain]} not found for user ${_ARG[username]}"
fi

raise notice "Deleted web host ${_ARG[domain]} in the web server configuration"

if [ "${_FLAG["delete-root"]}" = 1 ]; then
	if [ -d "/home/${_ARG[username]}/${_ARG[domain]}" ]; then
		rm -Rf /home/"${username:?}"/"${_ARG[domain]}"
		raise notice "Deleted web root for ${_ARG[domain]}"
	fi
fi

}